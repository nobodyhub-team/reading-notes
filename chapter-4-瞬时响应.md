# Chapter 4: 瞬时响应: 网站的高性能架构

## 性能测试指标
* 响应时间(Response Time)

|操作|响应时间|
|:-:|:------:|
|打开一个网站|几秒|
|在数据库中查询一条记录(有索引)|十几毫秒|
|机械磁盘一次寻址定位|4毫秒|
|从机械磁盘顺序读取1MB数据|2毫秒|
|从SSD磁盘顺序读取1MB数据|0.3毫秒|
|从远程分布式缓存Redis读取一个数据|0.5毫秒|
|从内存中读取1MB数据|十几微秒|
|Java本地方法调用|几微秒|
|网络传输2KB数据|1微秒|

* 并发数(Concurrency)
* 吞吐量(Throughput)
    - 请求数/秒
    - 页面数/秒
    - 访问人数/天
    - 处理业务数/小时
    - TPS(每秒事务数)
    - HPS(每秒HTTP请求数)
    - QPS(每秒查询数)
    - ...
* 性能计数器(Performance Indicator)
    - 系统负载
    - 对象与线程数
    - 内存使用
    - CPU使用
    - 磁盘与网络I/O
    - ...
    
## 性能测试方法
* 性能测试(Performance Test)
    以系统设计初期规划的性能指标为预期目标, 对系统不断事假压力, 验证系统在资源可接受范围内, 能否达到性能预期.
* 负载测试(Load Test)
    对系统不断地增加并发请求以增加系统压力, 直到系统的某项或多项性能指标达到安全临界值.
* 压力测试(Pressure Test)
    超过安全负载的情况下, 对系统继续施加压力, 直到系统崩溃或不能在处理任何请求, 以此获得系统最大压力承受能力.
* 稳定性测试(Stability Test)
    被测试系统在特定硬件, 软件, 网络环境条件下, 给系统加载一定的业务压力, 是系统运行一段较长的时间, 以此检验系统是否稳定.
    
## Web前端性能优化
* 浏览器访问优化 
    - 减少HTTP请求
    - 使用浏览器缓存
    - 启用压缩
    - CSS放在页面最上面, JavaScript放在页面最下面
    - 减少Cookie传输
* CDN加速
* 反向代理

## 应用服务器性能优化
* 分布式缓存
    - 频繁修改数据 -- 数据读写比在2:1以上
    - 没有热点的访问 -- 大部分数据访问需集中在小部分数据上.
    - 数据不一致与脏读 -- 容忍失效时间内的数据不一致
    - 缓存可用性 -- 使用缓存服务器集群
    - 缓存穿透 -- 缓存不存在的数据(value==null)
    
* 分布式缓存架构
    - 需要更新同步的分布式缓存, JBoss Cache
        在集群中所有的服务器中保存相同的缓存数据, 当某台服务器有缓存数据更新的时候, 会通知急群众其他机器更行缓存数据或清除缓存数据.
    - 不互相通讯的分布式缓存, Memcached
        缓存与应用服务器分离部署, 缓存系统部署在一组专门的服务器上, 应用程序通过一致性Hash等路由算法选择缓存服务器远程访问缓存, 缓存服务器之间不通讯,
        缓存集群的规模可以很容易地实现扩容, 具有良好的可伸缩性. 
* 异步操作
* 使用集群
* 代码优化
    - 多线程
    - 资源复用
    - 数据结构, 灵活组合各种数据结构改善数据读写和计算特性可极大优化程序的性能
    - 垃圾回收, 应根据系统业务特点和对象声明周期, 合理设置Young Generation和Old Generation的大小, 尽量减少Full GC.
## 存储性能优化
* 机械键盘 vs. 固态硬盘
* B+树 vs. LSM(Log-structured merge-tree)树
* RAID
    - RAID 0: 根据磁盘数量将数据分成N份, 同时并发写入N块磁盘, 使得数据整体写入数据是一块磁盘的N倍
    - RAID 1: 将一份数据同时写入两块磁盘
    - RAID 10: 结合RAID 0和RAID 1, 将所有磁盘平均分成两份, 数据同时在两份磁盘写入, 相当于RAID 1. 但是在每一份磁盘里面的N/2块磁盘上, 利用RAID 0 技术并发读写.
    - RAID 3: 将数据分成N-1份, 并发介入N-1块磁盘, 并在第N块磁盘记录校验数据.(第N块磁盘比其他磁盘容易损坏, 很少实践使用)
    - RAID 5: 和RAID 3类似, 但是校验数据不是写入第N块磁盘, 而是螺旋式地写入所有磁盘中. 
    - RAID 6: 和RAID 5类似, 但是数据只写入N-2块磁盘, 并螺旋式地在两块磁盘中写入校验信息.
    
    |RAID 类型|访问速度|数据可靠性|磁盘利用率|
    |:-------:|:----:|:-------:|:-------:|
    |RAID 0|很快|很低|100%|
    |RAID 1|很慢|很高|50%|
    |RAID 10|中等|很高|50%|    
    |RAID 5|较快|较高|(N-1)/N|
    |RAID 6|较快|较(RAID 5)高|(N-2)/N|
 
* HDFS(Hadoop Distributed File System)
    一个文件被分割成若干Block, 当应用程序写文件时, 每写完一个Block, 就将其自动复制到另外两台服务器上, 保证每个Block有三个副本.(相当于实现RAID 1的数据复制功能)
    当对文件进行处理计算时, 通过MapReduce并发计算任务框架, 可以启动多个计算子任务, 同时读取文件的多个Block并发处理(相当于实现了RAID  0 的并发访问功能)
     
[Home](README.md), [Previous](chapter-3-大型网站核心要素.md), [Next](chapter-5-万无一失.md)