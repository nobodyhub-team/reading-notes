# Chapter 5: 万无一失

## 网站可用性度量
故障时间 = 故障修复时间点 - 故障发现(报告)时间点
汪涵年度可用性指标 = (1 - 网站不可用时间/年度总时间)*100%

## 网站可用性考核

|分类|描述|权重|
|:--:|:-:|:--:|
|事故级故障|严重故障, 网站整体不可用|100|
|A类故障|网站访问不顺畅或核心功能不可用|20|
|B类故障|非核心功能不可用, 或核心功能少数用户不可用|5|
|C类故障|以上故障意外的其他故障|1|

故障分 = 故障时间(分钟) * 故障权重

## 高可用的应用
### 无状态应用
应用服务器不保存业务的上下文信息, 而仅根据没错请求提交的数据进行相应的业务逻辑处理,
 多个服务实例(服务器)之间完全对等, 请求提交到任意服务器, 处理结果都是完全一样的.
* 通过负载均衡进行无状态服务器的实效转移
* 应用服务器集群的Session管理
    - Session复制, 在集群中同步Session对象, 适用于小集群
    - Session绑定, 利用负载均衡的源地址Hash算法, 负载均衡服务器总是将来源于同一个用户的请求分发到同一台服务器上. 但不符合高可用性需求.
    - 利用Cookie记录Session, 将Session记录在客户端, 每次请求服务器的时候, 将Session放在请求中发送给服务器, 服务器处理完请求后再将修改过的Session响应给客户端
    - Session服务器: 利用独立部署的Session服务器(集群)统一管理Session, 应用服务器每次读写Session时, 都访问Session服务器.
    
## 高可用的服务
可复用的服务和应用一样, 也是无状态的服务, 因此可以使用类似负载均衡的失效转移策略实现高可用的服务. 除此之外, 还有以下几点高可用的服务策略:
* 分级管理(Hierarchical Management): 将服务器进行分级管理, 核心应用和服务使用更好的硬件, 在运维响应速度上也格外迅速. 在服务部署上进行必要的隔离, 避免故障的连锁反应.
* 超时设置(Timeout Settings): 设置服务调用的超时时间, 一旦超时, 通讯框架就抛出异常, 应用程序根据服务调度策略, 可萱蕚继续重试或将请求转移到提供相同服务的其他服务器上.
* 异步调用(Asynchronous Call): 通过消息队列等异步方式, 避免一个服务失败导致整个应用请求失败的情况.
* 服务降级(Service Downgrade): 在大量的并发调用和性能下降时, 为了保证核心应用和功能正常运行, 对服务进行降级.主要包含两种手段
    - 拒绝服务: 拒绝低优先级应用的调用, 减少服务调用并发数, 保证核心应用正常使用; 或者随机拒绝部分请求调用, 节约资源, 让另一部分请求得意成功.
    - 关闭功能: 关闭部分不重要的服务, 或者服务内关系部分不中要的功能.
* 幂等性设计(Idempotence Design): 保证在服务层保证服务重复调用和调用一次产生的结果相同

## 高可用数据
保证数据存储高可用性的主要手段:
* 数据备份: 保证数据有多个副本, 任意副本的实效都不会导致数据的永久丢失, 从而实现数据完全的持久化
* 实效转移机制: 保证当一个数据副本不可访问时, 可以快速切换访问数据的副本, 保证系统可用

### CAP原理
CAP原理认为, 一个提供数据服务的存储系统无法同时满足一下三个指标:
* 数据一致性(Consistency), 所有应用程序都能访问得到相同的数据
* 数据可用性(Availability), 任何时候, 任何应用程序都可以读写访问
* 分区耐受性(Partition Tolerance), 系统具有跨网络分区的伸缩性

[Home](README.md), [Previous](chapter-4-瞬时响应.md), [Next](chapter-6-永无止境.md)